pipeline {
    agent any
    
    stages {
        stage('Check Azure Secret') {
            steps {
                container('aks-builder') {
                    sh "az login --service-principal --username $AAD_SERVICE_PRINCIPAL_USR --password $AAD_SERVICE_PRINCIPAL_PSW --tenant $AKS_TENANT"
                    script {
                        def secretName = "masterjenkins-jenkins"
                        def vaultName = "ndop-plt-develop-kv"
                        def secretExists = azureSecretExists(vaultName, secretName)
                        while (!secretExists){
                            echo "Azure secret ${secretName} does not exist yet"
                        }
                        if (secretExists) {
                            build job: 'jobToRun', propagate: true
                        } 
                    }
                }
            }
        }
    }
    
    # triggers {
    #     upstream(upstreamProjects: 'my-upstream-project', threshold: hudson.model.Result.SUCCESS)
    # }
}

def azureSecretExists(vaultName, secretName) {
    def val = sh(script: "az keyvault secret show --vault-name ${vaultName} --name ${secretName} --query value -o tsv", returnStdout: true).trim()
    println(val)
    return val==null
}
